name: üì¢ Deployment Notifications

on:
  workflow_run:
    workflows: ["üöÄ Deploy to Vercel (with Cloud Run Gatekeeper)"]
    types:
      - completed

jobs:
  notify:
    name: üîî Send Deployment Alert
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: üì• Get workflow status
      id: status
      run: |
        if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
          echo "STATUS=‚úÖ SUCCESS" >> $GITHUB_OUTPUT
          echo "COLOR=3066993" >> $GITHUB_OUTPUT  # Green
          echo "MESSAGE=Photo2Profit deployed successfully! üíé" >> $GITHUB_OUTPUT
        else
          echo "STATUS=üö® BLOCKED" >> $GITHUB_OUTPUT  
          echo "COLOR=15158332" >> $GITHUB_OUTPUT  # Red
          echo "MESSAGE=Deployment blocked by gatekeeper! Backend health check failed." >> $GITHUB_OUTPUT
        fi

    - name: üîî Discord Notification
      if: secrets.DISCORD_WEBHOOK != ''
      uses: Ilshidur/action-discord@master
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        DISCORD_EMBEDS: |
          [
            {
              "title": "Photo2Profit Deployment",
              "description": "${{ steps.status.outputs.MESSAGE }}",
              "color": ${{ steps.status.outputs.COLOR }},
              "fields": [
                {
                  "name": "Status",
                  "value": "${{ steps.status.outputs.STATUS }}",
                  "inline": true
                },
                {
                  "name": "Branch",
                  "value": "${{ github.event.workflow_run.head_branch }}",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "${{ github.event.workflow_run.head_sha }}",
                  "inline": true
                }
              ],
              "timestamp": "${{ github.event.workflow_run.updated_at }}"
            }
          ]

    - name: üìß Email Notification (Success)
      if: github.event.workflow_run.conclusion == 'success'
      run: |
        echo "üéâ SUCCESS: Photo2Profit deployment completed!"
        echo "‚úÖ All backend endpoints healthy"
        echo "üöÄ Frontend deployed to production"
        echo "üíé Photo2Payday Baddie Mode is LIVE!"

    - name: üö® Email Notification (Blocked)  
      if: github.event.workflow_run.conclusion != 'success'
      run: |
        echo "üö® ALERT: Photo2Profit deployment BLOCKED!"
        echo "‚ùå Backend health check failed"
        echo "üõ°Ô∏è Gatekeeper prevented broken code from going live"
        echo ""
        echo "üîç Next steps:"
        echo "1. Check Cloud Run logs: gcloud logs read --service=photo2profit-api"
        echo "2. Test endpoints: npm run verify:prod"
        echo "3. Fix issues and push again"
        echo ""
        echo "‚ö†Ô∏è Production site remains on last known good build"

    # Optional: Slack notification
    - name: üì± Slack Notification
      if: secrets.SLACK_WEBHOOK != ''
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ steps.status.outputs.STATUS }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        text: |
          Photo2Profit Deployment: ${{ steps.status.outputs.STATUS }}
          ${{ steps.status.outputs.MESSAGE }}