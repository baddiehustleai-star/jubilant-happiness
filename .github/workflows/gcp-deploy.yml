name: Deploy to Google Cloud

on:
  push:
    branches:
      - main # Triggers on push to main branch
  workflow_dispatch: # Allows manual trigger from GitHub Actions UI

env:
  PROJECT_ID: photo2profitbaddie # Your GCP Project ID
  REGION: us-west2 # GCP region for deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          # Workload Identity Federation (recommended):
          workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ secrets.GCP_WORKLOAD_IDENTITY_POOL }}/providers/${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}'
          # Alternative: Service Account Key JSON (less secure, consider Workload Identity Federation):
          # credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # Example: Deploy to App Engine
      # Uncomment and configure if using App Engine
      # - name: Deploy to App Engine
      #   run: |
      #     gcloud app deploy --quiet --project=${{ env.PROJECT_ID }}

      # Example: Deploy to Cloud Run
      # Uncomment and configure if using Cloud Run
      # - name: Deploy to Cloud Run
      #   run: |
      #     gcloud run deploy YOUR-SERVICE-NAME \
      #       --source . \
      #       --region ${{ env.REGION }} \
      #       --platform managed \
      #       --allow-unauthenticated

      # Example: Deploy to Cloud Functions
      # Uncomment and configure if using Cloud Functions
      # - name: Deploy to Cloud Functions
      #   run: |
      #     gcloud functions deploy YOUR-FUNCTION-NAME \
      #       --runtime nodejs20 \
      #       --trigger-http \
      #       --allow-unauthenticated \
      #       --region ${{ env.REGION }}

      # Example: Deploy to GKE (Google Kubernetes Engine)
      # Uncomment and configure if using GKE
      # - name: Deploy to GKE
      #   run: |
      #     gcloud container clusters get-credentials YOUR-CLUSTER-NAME \
      #       --region ${{ env.REGION }}
      #     kubectl apply -f k8s/

      # Placeholder deployment step - customize based on your service
      - name: Deployment placeholder
        run: |
          echo "‚úÖ GCP authentication successful!"
          echo "üìù Configure the deployment steps above for your target GCP service:"
          echo "   - App Engine: gcloud app deploy"
          echo "   - Cloud Run: gcloud run deploy"
          echo "   - Cloud Functions: gcloud functions deploy"
          echo "   - GKE: kubectl apply"
          echo "   - Cloud Storage: gsutil rsync"
          echo ""
          echo "üîë Required GitHub Secrets for Workload Identity Federation (Recommended):"
          echo "   - GCP_PROJECT_NUMBER: Your GCP project number"
          echo "   - GCP_WORKLOAD_IDENTITY_POOL: Workload Identity Pool name"
          echo "   - GCP_WORKLOAD_IDENTITY_PROVIDER: Workload Identity Provider name"
          echo "   - GCP_SERVICE_ACCOUNT_EMAIL: Service account email"
          echo ""
          echo "üîë Alternative: Service Account Key JSON (Less Secure):"
          echo "   - GCP_SA_KEY: Service account JSON key"
          echo ""
          echo "   Add these secrets in:"
          echo "   Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"

      - name: Verify gcloud configuration
        run: |
          echo "Current GCP project: $(gcloud config get-value project)"
          echo "Current GCP region: ${{ env.REGION }}"
          gcloud --version
