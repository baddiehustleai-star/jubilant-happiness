name: üöÄ Final Deployment Checklist

on:
  push:
    branches: [main]
    paths:
      - 'api/**'
      - 'scripts/**'
      - '.github/workflows/final-deployment-checklist.yml'
  workflow_dispatch:
    inputs:
      skip_deploy:
        description: 'Skip deployment (only run verification)'
        required: false
        type: boolean
        default: false

env:
  PROJECT_ID: 758851214311
  SERVICE_NAME: photo2profit-api
  REGION: us-central1
  CLOUD_RUN_URL: https://photo2profit-api-uc.a.run.app

jobs:
  deployment-checklist:
    name: üéØ Final Deployment Checklist
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm install node-fetch@3 dotenv

      - name: üîê Authenticate to Google Cloud (if credentials available)
        if: ${{ github.event.inputs.skip_deploy != 'true' && secrets.GCP_SA_KEY != '' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          
      - name: üîß Setup gcloud CLI
        if: ${{ github.event.inputs.skip_deploy != 'true' && secrets.GCP_SA_KEY != '' }}
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: üöÄ Deploy API to Cloud Run
        if: ${{ github.event.inputs.skip_deploy != 'true' && secrets.GCP_SA_KEY != '' }}
        run: |
          echo "üöÄ Deploying API to Cloud Run..."
          cd api
          gcloud run deploy $SERVICE_NAME \
            --source . \
            --platform managed \
            --region $REGION \
            --allow-unauthenticated \
            --port 8080 \
            --memory 1Gi \
            --cpu 1 \
            --max-instances 10 \
            --timeout 60s \
            --set-env-vars "NODE_ENV=production,PROJECT_ID=$PROJECT_ID" \
            --quiet
          
          # Get deployed URL
          export CLOUD_RUN_URL=$(gcloud run services describe $SERVICE_NAME \
            --region=$REGION \
            --format="value(status.url)")
          echo "CLOUD_RUN_URL=$CLOUD_RUN_URL" >> $GITHUB_ENV
          echo "‚úÖ Deployed to: $CLOUD_RUN_URL"
          
          # Wait for service to stabilize
          echo "‚è≥ Waiting for service to stabilize..."
          sleep 10

      - name: ‚è≠Ô∏è Skip deployment notice
        if: ${{ github.event.inputs.skip_deploy == 'true' || secrets.GCP_SA_KEY == '' }}
        run: |
          echo "‚ÑπÔ∏è Skipping deployment - using existing Cloud Run URL"
          echo "üåê Testing against: $CLOUD_RUN_URL"

      - name: üîç Step 1: Check Environment Variables
        run: |
          echo "üîê Checking Environment Variables..."
          
          # Check for required variables (use example values for CI)
          export VITE_FIREBASE_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID || 'photo2profit-758851214311' }}"
          export VITE_FIREBASE_API_KEY="${{ secrets.FIREBASE_API_KEY || 'test-key' }}"
          export VITE_STRIPE_PUBLISHABLE_KEY="${{ secrets.STRIPE_PUBLISHABLE_KEY || 'pk_test_example' }}"
          
          echo "‚úÖ VITE_FIREBASE_PROJECT_ID: ${VITE_FIREBASE_PROJECT_ID:0:20}..."
          echo "‚úÖ VITE_FIREBASE_API_KEY: ${VITE_FIREBASE_API_KEY:0:10}..."
          echo "‚úÖ VITE_STRIPE_PUBLISHABLE_KEY: ${VITE_STRIPE_PUBLISHABLE_KEY:0:15}..."

      - name: üîç Step 2: Verify API Deployment
        run: |
          echo "üöÄ Verifying API Deployment..."
          echo "Testing: $CLOUD_RUN_URL/health"
          
          response=$(curl -s -w "\n%{http_code}" "$CLOUD_RUN_URL/health")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ API Health Check: PASSED"
            echo "Response: $body"
          else
            echo "‚ùå API Health Check: FAILED (HTTP $http_code)"
            exit 1
          fi

      - name: üîç Step 3: Test SEO Refresh Endpoint
        run: |
          echo "üîç Testing SEO Refresh Endpoint..."
          echo "Testing: POST $CLOUD_RUN_URL/api/seo/refresh"
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET || 'test-secret' }}" \
            "$CLOUD_RUN_URL/api/seo/refresh?limit=1")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "200" ] || [ "$http_code" = "403" ]; then
            echo "‚úÖ SEO Refresh Endpoint: RESPONDING"
            echo "Response: $body"
            echo "Note: 403 is expected without proper CRON_SECRET in production"
          else
            echo "‚ùå SEO Refresh Endpoint: FAILED (HTTP $http_code)"
            exit 1
          fi

      - name: üîç Step 4: Confirm Product Page Functionality
        run: |
          echo "üìÑ Testing Product Page Functionality..."
          echo "Testing: GET $CLOUD_RUN_URL/share/test-product"
          
          response=$(curl -s -w "\n%{http_code}" "$CLOUD_RUN_URL/share/test-product")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "200" ] || [ "$http_code" = "404" ]; then
            echo "‚úÖ Product Page Route: FUNCTIONAL"
            if [ "$http_code" = "404" ]; then
              echo "Note: 404 is expected for non-existent test product"
            else
              echo "Response preview: ${body:0:200}..."
            fi
          else
            echo "‚ùå Product Page Route: FAILED (HTTP $http_code)"
            exit 1
          fi

      - name: üîç Step 5: Run Complete Verification
        run: |
          echo "üîç Running comprehensive deployment checklist..."
          export CLOUD_RUN_URL="$CLOUD_RUN_URL"
          export VITE_FIREBASE_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID || 'photo2profit-758851214311' }}"
          export VITE_FIREBASE_API_KEY="${{ secrets.FIREBASE_API_KEY || 'test-key' }}"
          export VITE_STRIPE_PUBLISHABLE_KEY="${{ secrets.STRIPE_PUBLISHABLE_KEY || 'pk_test_example' }}"
          
          node scripts/final-deployment-checklist.js

      - name: üìä Deployment Summary
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "üìä DEPLOYMENT CHECKLIST SUMMARY"
          echo "========================================"
          echo "üåê API URL: $CLOUD_RUN_URL"
          echo "üì¶ Project: $PROJECT_ID"
          echo "üåç Region: $REGION"
          echo ""
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ ALL CHECKS PASSED!"
            echo ""
            echo "üéâ Photo2Profit API is production-ready!"
            echo ""
            echo "üìã Next Steps:"
            echo "1. Update Vercel environment:"
            echo "   VITE_API_BASE=$CLOUD_RUN_URL"
            echo "2. Verify frontend deployment"
            echo "3. Test end-to-end user flows"
          else
            echo "‚ùå SOME CHECKS FAILED"
            echo "Please review the logs above for details."
          fi

      - name: üì¢ Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment verification failed!"
          echo "Check the logs above for specific errors."
          exit 1
